name: Build & Release CX Studio

on:
  push:
    tags:
      - "v*"

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest]

    steps:
      - name: Checkout cx-studio code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install npm dependencies
        run: npm install

      - name: Determine Backend Asset Filename
        id: set_asset_name
        shell: bash
        run: |
          VERSION="v0.7.0"
          # Use matrix.os to get "ubuntu-latest", then process it.
          # This EXACTLY mirrors the logic in the cx-shell repository.
          OS_NAME=$(echo ${{ matrix.os }} | tr '[:upper:]' '[:lower:]' | sed 's/-latest//')

          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            echo "ASSET_NAME=cx-${VERSION}-${OS_NAME}-amd64.zip" >> $GITHUB_ENV
          else
            # This now correctly handles 'macos' and 'ubuntu'.
            echo "ASSET_NAME=cx-${VERSION}-${OS_NAME}-x86_64.tar.gz" >> $GITHUB_ENV
          fi

      - name: Download cx-server artifact
        uses: robinraju/release-downloader@v1
        with:
          repository: "flowcontextually/cx-shell"
          tag: "v0.7.0"
          fileName: "${{ env.ASSET_NAME }}"
          out-file-path: "./bin/"

      - name: Prepare cx-server executable
        shell: bash
        run: |
          mkdir -p ./resources
          ARCHIVE=$(find ./bin -type f -name "cx-*.zip" -o -name "cx-*.tar.gz")
          echo "Found archive: $ARCHIVE"
          if [[ "$ARCHIVE" == *.zip ]]; then
            unzip "$ARCHIVE" -d ./bin
          else
            tar -xzf "$ARCHIVE" -C ./bin
          fi
          EXECUTABLE_NAME="cx"
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            EXECUTABLE_NAME="cx.exe"
          fi
          mv ./bin/${EXECUTABLE_NAME} ./resources/cx-server
          if [[ "${{ runner.os }}" != "Windows" ]]; then
            chmod +x ./resources/cx-server
          fi

      - name: Update package.json for build
        run: |
          npm install -g json
          json -I -f package.json -e "this.build.extraResources=[{'from':'./resources/cx-server','to':'cx-server'}]"

      # --- START OF DEFINITIVE FIX ---
      - name: Build and package the application
        # We tell electron-builder NEVER to auto-publish.
        # The 'release' job is responsible for publishing.
        run: npm run electron:build -- --publish never
      # --- END OF DEFINITIVE FIX ---

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: cx-studio-${{ matrix.os }}
          # This precise glob matches the known output formats from electron-builder.
          # It looks for files that START with 'Contextually Studio' and end with the correct extension.
          path: |
            dist/Contextually Studio*.exe
            dist/Contextually-Studio-*.AppImage
            dist/Contextually-Studio-*.dmg
            dist/Contextually-Studio-*.deb
            dist/Contextually-Studio-*.msi
          # Tell the action not to fail if one of the patterns doesn't match (e.g., no .dmg on Windows)
          if-no-files-found: ignore
  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    # --- PERMISSIONS ARE ONLY NEEDED HERE ---
    permissions:
      contents: write
    # --- END ---
    steps:
      - name: Download all installer artifacts
        uses: actions/download-artifact@v4
        with:
          path: installers

      - name: Create release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: installers/**/*
